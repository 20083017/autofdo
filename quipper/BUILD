# -*- mode: python; -*-
# Copyright 2013 Google Inc. All Rights Reserved.
# Author: asharif@google.com (Ahmad Sharif)
# Description:
#   Library for handling perf.data files.

# TODO(asharif): Consult a lawyer.
licenses(["notice"])  # BSD

exports_files(["LICENSE"])

perf_test_data = [
    "testdata/hello_world.txt.gz",
    "testdata/perf",
    "testdata/perf.callgraph.pb_text",
    "testdata/perf.data.armv7",
    "testdata/perf.data.armv7.io.out.pb_text.gz",
    "testdata/perf.data.armv7.parse.out.pb_text.gz",
    "testdata/perf.data.armv7.parse.remap2.out.pb_text.gz",
    "testdata/perf.data.armv7.parse.remap.out.pb_text.gz",
    "testdata/perf.data.armv7.pb_text.gz",
    "testdata/perf.data.armv7.perf_3.14",
    "testdata/perf.data.armv7.perf_3.14.io.out.pb_text.gz",
    "testdata/perf.data.armv7.perf_3.14.parse.out.pb_text.gz",
    "testdata/perf.data.armv7.perf_3.14.parse.remap2.out.pb_text.gz",
    "testdata/perf.data.armv7.perf_3.14.parse.remap.out.pb_text.gz",
    "testdata/perf.data.armv7.perf_3.14.pb_text.gz",
    "testdata/perf.data.armv7.perf_3.14.pr.out.pb_text.gz",
    "testdata/perf.data.armv7.perf_3.14.ser.comm.out.pb_text.gz",
    "testdata/perf.data.armv7.perf_3.14.serialized.out.pb_text.gz",
    "testdata/perf.data.armv7.pr.out.pb_text.gz",
    "testdata/perf.data.armv7.ser.comm.out.pb_text.gz",
    "testdata/perf.data.armv7.serialized.out.pb_text.gz",
    "testdata/perf.data.branch",
    "testdata/perf.data.branch.io.out.pb_text.gz",
    "testdata/perf.data.branch.next",
    "testdata/perf.data.branch.next.buildids",
    "testdata/perf.data.branch.next.io.out.pb_text.gz",
    "testdata/perf.data.branch.next.parse.out.pb_text.gz",
    "testdata/perf.data.branch.next.parse.remap2.out.pb_text.gz",
    "testdata/perf.data.branch.next.parse.remap.out.pb_text.gz",
    "testdata/perf.data.branch.next.pb_text.gz",
    "testdata/perf.data.branch.next.pr.out.pb_text.gz",
    "testdata/perf.data.branch.next.ser.comm.out.pb_text.gz",
    "testdata/perf.data.branch.next.serialized.out.pb_text.gz",
    "testdata/perf.data.branch.parse.out.pb_text.gz",
    "testdata/perf.data.branch.parse.remap2.out.pb_text.gz",
    "testdata/perf.data.branch.parse.remap.out.pb_text.gz",
    "testdata/perf.data.branch.pb_text.gz",
    "testdata/perf.data.branch.pr.out.pb_text.gz",
    "testdata/perf.data.branch.ser.comm.out.pb_text.gz",
    "testdata/perf.data.branch.serialized.out.pb_text.gz",
    "testdata/perf.data.busy.0",
    "testdata/perf.data.busy.0.io.out.pb_text.gz",
    "testdata/perf.data.busy.0.next",
    "testdata/perf.data.busy.0.next.buildids",
    "testdata/perf.data.busy.0.next.io.out.pb_text.gz",
    "testdata/perf.data.busy.0.next.parse.out.pb_text.gz",
    "testdata/perf.data.busy.0.next.parse.remap2.out.pb_text.gz",
    "testdata/perf.data.busy.0.next.parse.remap.out.pb_text.gz",
    "testdata/perf.data.busy.0.next.pb_text.gz",
    "testdata/perf.data.busy.0.next.pr.out.pb_text.gz",
    "testdata/perf.data.busy.0.next.ser.comm.out.pb_text.gz",
    "testdata/perf.data.busy.0.next.serialized.out.pb_text.gz",
    "testdata/perf.data.busy.0.parse.out.pb_text.gz",
    "testdata/perf.data.busy.0.parse.remap2.out.pb_text.gz",
    "testdata/perf.data.busy.0.parse.remap.out.pb_text.gz",
    "testdata/perf.data.busy.0.pb_text.gz",
    "testdata/perf.data.busy.0.pr.out.pb_text.gz",
    "testdata/perf.data.busy.0.ser.comm.out.pb_text.gz",
    "testdata/perf.data.busy.0.serialized.out.pb_text.gz",
    "testdata/perf.data.busy.1",
    "testdata/perf.data.busy.1.io.out.pb_text.gz",
    "testdata/perf.data.busy.1.next",
    "testdata/perf.data.busy.1.next.buildids",
    "testdata/perf.data.busy.1.next.io.out.pb_text.gz",
    "testdata/perf.data.busy.1.next.parse.out.pb_text.gz",
    "testdata/perf.data.busy.1.next.parse.remap2.out.pb_text.gz",
    "testdata/perf.data.busy.1.next.parse.remap.out.pb_text.gz",
    "testdata/perf.data.busy.1.next.pb_text.gz",
    "testdata/perf.data.busy.1.next.pr.out.pb_text.gz",
    "testdata/perf.data.busy.1.next.ser.comm.out.pb_text.gz",
    "testdata/perf.data.busy.1.next.serialized.out.pb_text.gz",
    "testdata/perf.data.busy.1.parse.out.pb_text.gz",
    "testdata/perf.data.busy.1.parse.remap2.out.pb_text.gz",
    "testdata/perf.data.busy.1.parse.remap.out.pb_text.gz",
    "testdata/perf.data.busy.1.pb_text.gz",
    "testdata/perf.data.busy.1.pr.out.pb_text.gz",
    "testdata/perf.data.busy.1.ser.comm.out.pb_text.gz",
    "testdata/perf.data.busy.1.serialized.out.pb_text.gz",
    "testdata/perf.data.busy.5",
    "testdata/perf.data.busy.5.io.out.pb_text.gz",
    "testdata/perf.data.busy.5.next",
    "testdata/perf.data.busy.5.next.buildids",
    "testdata/perf.data.busy.5.next.io.out.pb_text.gz",
    "testdata/perf.data.busy.5.next.parse.out.pb_text.gz",
    "testdata/perf.data.busy.5.next.parse.remap2.out.pb_text.gz",
    "testdata/perf.data.busy.5.next.parse.remap.out.pb_text.gz",
    "testdata/perf.data.busy.5.next.pb_text.gz",
    "testdata/perf.data.busy.5.next.pr.out.pb_text.gz",
    "testdata/perf.data.busy.5.next.ser.comm.out.pb_text.gz",
    "testdata/perf.data.busy.5.next.serialized.out.pb_text.gz",
    "testdata/perf.data.busy.5.parse.out.pb_text.gz",
    "testdata/perf.data.busy.5.parse.remap2.out.pb_text.gz",
    "testdata/perf.data.busy.5.parse.remap.out.pb_text.gz",
    "testdata/perf.data.busy.5.pb_text.gz",
    "testdata/perf.data.busy.5.pr.out.pb_text.gz",
    "testdata/perf.data.busy.5.ser.comm.out.pb_text.gz",
    "testdata/perf.data.busy.5.serialized.out.pb_text.gz",
    "testdata/perf.data.callgraph",
    "testdata/perf.data.callgraph_and_branch",
    "testdata/perf.data.callgraph_and_branch.next",
    "testdata/perf.data.callgraph_and_branch.next.buildids",
    "testdata/perf.data.callgraph_and_branch.next.pb_text.gz",
    "testdata/perf.data.callgraph_and_branch.pb_text.gz",
    "testdata/perf.data.callgraph.next",
    "testdata/perf.data.callgraph.next.buildids",
    "testdata/perf.data.callgraph.next.pb_text.gz",
    "testdata/perf.data.callgraph.pb_text.gz",
    "testdata/perf.data.forkexit",
    "testdata/perf.data.forkexit.io.out.pb_text.gz",
    "testdata/perf.data.forkexit.next",
    "testdata/perf.data.forkexit.next.buildids",
    "testdata/perf.data.forkexit.next.io.out.pb_text.gz",
    "testdata/perf.data.forkexit.next.parse.out.pb_text.gz",
    "testdata/perf.data.forkexit.next.parse.remap2.out.pb_text.gz",
    "testdata/perf.data.forkexit.next.parse.remap.out.pb_text.gz",
    "testdata/perf.data.forkexit.next.pb_text.gz",
    "testdata/perf.data.forkexit.next.pr.out.pb_text.gz",
    "testdata/perf.data.forkexit.next.ser.comm.out.pb_text.gz",
    "testdata/perf.data.forkexit.next.serialized.out.pb_text.gz",
    "testdata/perf.data.forkexit.parse.out.pb_text.gz",
    "testdata/perf.data.forkexit.parse.remap2.out.pb_text.gz",
    "testdata/perf.data.forkexit.parse.remap.out.pb_text.gz",
    "testdata/perf.data.forkexit.pb_text.gz",
    "testdata/perf.data.forkexit.pr.out.pb_text.gz",
    "testdata/perf.data.forkexit.ser.comm.out.pb_text.gz",
    "testdata/perf.data.forkexit.serialized.out.pb_text.gz",
    "testdata/perf.data.hw_and_sw",
    "testdata/perf.data.hw_and_sw.io.out.pb_text.gz",
    "testdata/perf.data.hw_and_sw.parse.out.pb_text.gz",
    "testdata/perf.data.hw_and_sw.parse.remap2.out.pb_text.gz",
    "testdata/perf.data.hw_and_sw.parse.remap.out.pb_text.gz",
    "testdata/perf.data.hw_and_sw.pb_text.gz",
    "testdata/perf.data.hw_and_sw.pr.out.pb_text.gz",
    "testdata/perf.data.hw_and_sw.ser.comm.out.pb_text.gz",
    "testdata/perf.data.hw_and_sw.serialized.out.pb_text.gz",
    "testdata/perf.data.i686",
    "testdata/perf.data.i686.io.out.pb_text.gz",
    "testdata/perf.data.i686.parse.out.pb_text.gz",
    "testdata/perf.data.i686.parse.remap2.out.pb_text.gz",
    "testdata/perf.data.i686.parse.remap.out.pb_text.gz",
    "testdata/perf.data.i686.pb_text.gz",
    "testdata/perf.data.i686.pr.out.pb_text.gz",
    "testdata/perf.data.i686.ser.comm.out.pb_text.gz",
    "testdata/perf.data.i686.serialized.out.pb_text.gz",
    "testdata/perf.data.numatopology",
    "testdata/perf.data.numatopology.io.out.pb_text.gz",
    "testdata/perf.data.numatopology.parse.out.pb_text.gz",
    "testdata/perf.data.numatopology.parse.remap2.out.pb_text.gz",
    "testdata/perf.data.numatopology.parse.remap.out.pb_text.gz",
    "testdata/perf.data.numatopology.pb_text.gz",
    "testdata/perf.data.numatopology.pr.out.pb_text.gz",
    "testdata/perf.data.numatopology.ser.comm.out.pb_text.gz",
    "testdata/perf.data.numatopology.serialized.out.pb_text.gz",
    "testdata/perf.data.piped.corrupted.zero_size_sample",
    "testdata/perf.data.piped.extrabyte",
    "testdata/perf.data.piped.extrabyte.pb_text.gz",
    "testdata/perf.data.piped.extrabyte.pr.out.pb_text.gz",
    "testdata/perf.data.piped.extradata",
    "testdata/perf.data.piped.extradata.pb_text.gz",
    "testdata/perf.data.piped.extradata.pr.out.pb_text.gz",
    "testdata/perf.data.piped.host",
    "testdata/perf.data.piped.host.pb_text.gz",
    "testdata/perf.data.piped.host.pr.out.pb_text.gz",
    "testdata/perf.data.piped.hw_and_sw",
    "testdata/perf.data.piped.hw_and_sw.pb_text.gz",
    "testdata/perf.data.piped.hw_and_sw.pr.out.pb_text.gz",
    "testdata/perf.data.piped.target",
    "testdata/perf.data.piped.target.next",
    "testdata/perf.data.piped.target.next.pb_text.gz",
    "testdata/perf.data.piped.target.next.pr.out.pb_text.gz",
    "testdata/perf.data.piped.target.pb_text.gz",
    "testdata/perf.data.piped.target.pr.out.pb_text.gz",
    "testdata/perf.data.piped.target.throttled",
    "testdata/perf.data.piped.target.throttled.pb_text.gz",
    "testdata/perf.data.piped.target.throttled.pr.out.pb_text.gz",
    "testdata/perf.data.raw",
    "testdata/perf.data.raw_callgraph_branch",
    "testdata/perf.data.raw_callgraph_branch.next.buildids",
    "testdata/perf.data.raw_callgraph_branch.pb_text.gz",
    "testdata/perf.data.raw.io.out.pb_text.gz",
    "testdata/perf.data.raw.next.buildids",
    "testdata/perf.data.raw.parse.out.pb_text.gz",
    "testdata/perf.data.raw.parse.remap2.out.pb_text.gz",
    "testdata/perf.data.raw.parse.remap.out.pb_text.gz",
    "testdata/perf.data.raw.pb_text.gz",
    "testdata/perf.data.raw.pr.out.pb_text.gz",
    "testdata/perf.data.raw.ser.comm.out.pb_text.gz",
    "testdata/perf.data.raw.serialized.out.pb_text.gz",
    "testdata/perf.data.remmap",
    "testdata/perf.data.remmap.io.out.pb_text.gz",
    "testdata/perf.data.remmap.parse.out.pb_text.gz",
    "testdata/perf.data.remmap.parse.remap2.out.pb_text.gz",
    "testdata/perf.data.remmap.parse.remap.out.pb_text.gz",
    "testdata/perf.data.remmap.pb_text.gz",
    "testdata/perf.data.remmap.pr.out.pb_text.gz",
    "testdata/perf.data.remmap.ser.comm.out.pb_text.gz",
    "testdata/perf.data.remmap.serialized.out.pb_text.gz",
    "testdata/perf.data.singleprocess",
    "testdata/perf.data.singleprocess.io.out.pb_text.gz",
    "testdata/perf.data.singleprocess.next",
    "testdata/perf.data.singleprocess.next.buildids",
    "testdata/perf.data.singleprocess.next.io.out.pb_text.gz",
    "testdata/perf.data.singleprocess.next.parse.out.pb_text.gz",
    "testdata/perf.data.singleprocess.next.parse.remap2.out.pb_text.gz",
    "testdata/perf.data.singleprocess.next.parse.remap.out.pb_text.gz",
    "testdata/perf.data.singleprocess.next.pb_text.gz",
    "testdata/perf.data.singleprocess.next.pr.out.pb_text.gz",
    "testdata/perf.data.singleprocess.next.ser.comm.out.pb_text.gz",
    "testdata/perf.data.singleprocess.next.serialized.out.pb_text.gz",
    "testdata/perf.data.singleprocess.parse.out.pb_text.gz",
    "testdata/perf.data.singleprocess.parse.remap2.out.pb_text.gz",
    "testdata/perf.data.singleprocess.parse.remap.out.pb_text.gz",
    "testdata/perf.data.singleprocess.pb_text.gz",
    "testdata/perf.data.singleprocess.pr.out.pb_text.gz",
    "testdata/perf.data.singleprocess.ser.comm.out.pb_text.gz",
    "testdata/perf.data.singleprocess.serialized.out.pb_text.gz",
    "testdata/perf.data.systemwide.0",
    "testdata/perf.data.systemwide.0.io.out.pb_text.gz",
    "testdata/perf.data.systemwide.0.next",
    "testdata/perf.data.systemwide.0.next.buildids",
    "testdata/perf.data.systemwide.0.next.io.out.pb_text.gz",
    "testdata/perf.data.systemwide.0.next.parse.out.pb_text.gz",
    "testdata/perf.data.systemwide.0.next.parse.remap2.out.pb_text.gz",
    "testdata/perf.data.systemwide.0.next.parse.remap.out.pb_text.gz",
    "testdata/perf.data.systemwide.0.next.pb_text.gz",
    "testdata/perf.data.systemwide.0.next.pr.out.pb_text.gz",
    "testdata/perf.data.systemwide.0.next.ser.comm.out.pb_text.gz",
    "testdata/perf.data.systemwide.0.next.serialized.out.pb_text.gz",
    "testdata/perf.data.systemwide.0.parse.out.pb_text.gz",
    "testdata/perf.data.systemwide.0.parse.remap2.out.pb_text.gz",
    "testdata/perf.data.systemwide.0.parse.remap.out.pb_text.gz",
    "testdata/perf.data.systemwide.0.pb_text.gz",
    "testdata/perf.data.systemwide.0.pr.out.pb_text.gz",
    "testdata/perf.data.systemwide.0.ser.comm.out.pb_text.gz",
    "testdata/perf.data.systemwide.0.serialized.out.pb_text.gz",
    "testdata/perf.data.systemwide.1",
    "testdata/perf.data.systemwide.1.io.out.pb_text.gz",
    "testdata/perf.data.systemwide.1.next",
    "testdata/perf.data.systemwide.1.next.buildids",
    "testdata/perf.data.systemwide.1.next.io.out.pb_text.gz",
    "testdata/perf.data.systemwide.1.next.parse.out.pb_text.gz",
    "testdata/perf.data.systemwide.1.next.parse.remap2.out.pb_text.gz",
    "testdata/perf.data.systemwide.1.next.parse.remap.out.pb_text.gz",
    "testdata/perf.data.systemwide.1.next.pb_text.gz",
    "testdata/perf.data.systemwide.1.next.pr.out.pb_text.gz",
    "testdata/perf.data.systemwide.1.next.ser.comm.out.pb_text.gz",
    "testdata/perf.data.systemwide.1.next.serialized.out.pb_text.gz",
    "testdata/perf.data.systemwide.1.parse.out.pb_text.gz",
    "testdata/perf.data.systemwide.1.parse.remap2.out.pb_text.gz",
    "testdata/perf.data.systemwide.1.parse.remap.out.pb_text.gz",
    "testdata/perf.data.systemwide.1.pb_text.gz",
    "testdata/perf.data.systemwide.1.pr.out.pb_text.gz",
    "testdata/perf.data.systemwide.1.ser.comm.out.pb_text.gz",
    "testdata/perf.data.systemwide.1.serialized.out.pb_text.gz",
    "testdata/perf.data.systemwide.5",
    "testdata/perf.data.systemwide.5.io.out.pb_text.gz",
    "testdata/perf.data.systemwide.5.next",
    "testdata/perf.data.systemwide.5.next.buildids",
    "testdata/perf.data.systemwide.5.next.io.out.pb_text.gz",
    "testdata/perf.data.systemwide.5.next.parse.out.pb_text.gz",
    "testdata/perf.data.systemwide.5.next.parse.remap2.out.pb_text.gz",
    "testdata/perf.data.systemwide.5.next.parse.remap.out.pb_text.gz",
    "testdata/perf.data.systemwide.5.next.pb_text.gz",
    "testdata/perf.data.systemwide.5.next.pr.out.pb_text.gz",
    "testdata/perf.data.systemwide.5.next.ser.comm.out.pb_text.gz",
    "testdata/perf.data.systemwide.5.next.serialized.out.pb_text.gz",
    "testdata/perf.data.systemwide.5.parse.out.pb_text.gz",
    "testdata/perf.data.systemwide.5.parse.remap2.out.pb_text.gz",
    "testdata/perf.data.systemwide.5.parse.remap.out.pb_text.gz",
    "testdata/perf.data.systemwide.5.pb_text.gz",
    "testdata/perf.data.systemwide.5.pr.out.pb_text.gz",
    "testdata/perf.data.systemwide.5.ser.comm.out.pb_text.gz",
    "testdata/perf.data.systemwide.5.serialized.out.pb_text.gz",
    "testdata/perf.data.throttle.next",
    "testdata/perf.data.throttle.next.buildids",
    "testdata/perf.data.throttle.next.io.out.pb_text.gz",
    "testdata/perf.data.throttle.next.parse.out.pb_text.gz",
    "testdata/perf.data.throttle.next.parse.remap2.out.pb_text.gz",
    "testdata/perf.data.throttle.next.parse.remap.out.pb_text.gz",
    "testdata/perf.data.throttle.next.pb_text.gz",
    "testdata/perf.data.throttle.next.pr.out.pb_text.gz",
    "testdata/perf.data.throttle.next.ser.comm.out.pb_text.gz",
    "testdata/perf.data.throttle.next.serialized.out.pb_text.gz",
]

utils_test_data = [
    "testdata/hello_world.txt.gz",
]

proto_library(
    name = "perf_data_proto",
    srcs = ["perf_data.proto"],
    cc_api_version = 2,
    go_api_version = 2,
    visibility = ["//visibility:public"],
)

cc_library(
    name = "perf_serializer",
    srcs = [
        "perf_serializer.cc",
    ],
    hdrs = ["perf_serializer.h"],
    visibility = ["//visibility:public"],
    deps = [
        ":perf_data_proto",
        ":perf_parser",
        ":perf_reader",
        ":utils",
        "//base",
    ],
)

cc_library(
    name = "perf_parser",
    srcs = [
        "perf_parser.cc",
    ],
    hdrs = ["perf_parser.h"],
    visibility = ["//visibility:public"],
    deps = [
        ":address_mapper",
        ":perf_reader",
        ":utils",
        "//base",
    ],
)

cc_library(
    name = "perf_reader",
    srcs = [
        "perf_reader.cc",
    ],
    hdrs = ["perf_reader.h"],
    visibility = ["//visibility:public"],
    deps = [
        ":utils",
        "//base",
    ],
)

cc_library(
    name = "perf_protobuf_io",
    srcs = [
        "perf_protobuf_io.cc",
    ],
    hdrs = ["perf_protobuf_io.h"],
    deps = ["perf_data_proto"],
)

cc_library(
    name = "address_mapper",
    srcs = [
        "address_mapper.cc",
    ],
    hdrs = ["address_mapper.h"],
    deps = [
        "//base",
    ],
)

cc_library(
    name = "utils",
    srcs = [
        "scoped_temp_path.cc",
        "utils.cc",
    ],
    hdrs = ["utils.h"],
    visibility = ["//visibility:public"],
    deps = [
        "//base",
        "//third_party/openssl:crypto",
        "//third_party/zlib",
    ],
)

cc_library(
    name = "test_utils",
    testonly = 1,
    srcs = [
        "test_utils.cc",
        "test_utils_defs.cc",
    ],
    hdrs = ["test_utils.h"],
    deps = [
        ":perf_data_proto",
        ":perf_serializer",
        "//base",
        "//testing/base/public:gunit",
    ],
)

# TODO(asharif): Add more tests once they work in google3.
cc_test(
    name = "perf_parser_test",
    srcs = ["perf_parser_test.cc"],
    data = perf_test_data,
    deps = [
        ":perf_data_proto",
        ":perf_parser",
        ":perf_protobuf_io",
        ":test_utils",
        "//testing/base/public:gunit",
    ],
)

cc_test(
    name = "perf_reader_test",
    srcs = ["perf_reader_test.cc"],
    data = perf_test_data,
    deps = [
        ":perf_data_proto",
        ":perf_protobuf_io",
        ":perf_reader",
        ":test_utils",
        "//testing/base/public:gunit",
    ],
)

cc_test(
    name = "perf_serializer_test",
    size = "large",
    srcs = ["perf_serializer_test.cc"],
    data = perf_test_data,
    deps = [
        ":perf_data_proto",
        ":perf_protobuf_io",
        ":perf_serializer",
        ":test_utils",
        "//testing/base/public:gunit",
    ],
)

cc_test(
    name = "utils_test",
    srcs = ["utils_test.cc"],
    data = utils_test_data,
    deps = [
        ":perf_data_proto",
        ":test_utils",
        ":utils",
        "//testing/base/public:gunit",
    ],
)

# TODO(sque): This works if run directly (python sync_quipper.py) or when called
# through blaze-bin/third_party/quipper/sync_quipper. However it fails when run
# using "blaze run". The error is:
#    ERROR:root:Error while copying file perf_reader.cc: Permission denied
# Try to resolve this problem so it can blaze-run successfully.
py_binary(
    name = "sync_quipper",
    srcs = ["sync_quipper.py"],
    deps = [
        "//pyglib",
    ],
)
